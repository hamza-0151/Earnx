<!DOCTYPE html>
<html>
<head>
  <title>EarnX App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--REFERRAL_PLACEHOLDER-->
  <style>
    :root {
      --primary: #6C5CE7;
      --secondary: #00CEFF;
      --accent: #FD79A8;
      --dark: #2D3436;
      --light: #F5F6FA;
      --error: #FF4757;
      --success: #00B894;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }
    
    .app-container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .logo-container {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      padding: 30px 20px;
      text-align: center;
      color: white;
    }
    
    .logo-container h1 {
      font-size: 2.5rem;
      margin-bottom: 5px;
      font-weight: 800;
    }
    
    .logo-container p {
      opacity: 0.9;
    }
    
    .auth-box {
      padding: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .input-with-icon {
      position: relative;
    }
    
    .input-with-icon input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
    }
    
    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
    }
    
    .eye-icon {
      width: 24px;
      height: 24px;
      fill: #777;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #5649c5;
    }
    
    .btn-secondary {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    .btn-secondary:hover {
      background: rgba(108, 92, 231, 0.1);
    }
    
    .auth-links {
      text-align: center;
      margin-top: 20px;
    }
    
    .auth-links a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    
    .message {
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 15px;
      text-align: center;
      display: none;
    }
    
    .error {
      background: rgba(255, 71, 87, 0.1);
      color: var(--error);
      border: 1px solid var(--error);
    }
    
    .success {
      background: rgba(0, 184, 148, 0.1);
      color: var(--success);
      border: 1px solid var(--success);
    }
    
    .loading {
      text-align: center;
      margin: 10px 0;
      display: none;
    }
    
    .loading-spinner {
      width: 30px;
      height: 30px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Home Page Styles */
    #homePage {
      display: none;
      max-width: 500px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: white;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .welcome {
      font-size: 18px;
      font-weight: 600;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    
    .invite-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .logout-btn {
      background: var(--error);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    
    /* How to Earn Section Styles */
    .earn-box {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .earn-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--primary);
      text-align: center;
    }
    
    .earn-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    
    .earn-info {
      display: flex;
      flex-direction: column;
    }
    
    .earn-reward {
      color: var(--primary);
      font-weight: 600;
      margin-top: 5px;
    }
    
    .conversion-rate {
      text-align: center;
      margin-top: 15px;
      font-weight: 500;
      color: var(--dark);
      padding: 10px;
      background: rgba(108, 92, 231, 0.1);
      border-radius: 8px;
    }
    
    .wallet-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .wallet-title {
      font-size: 16px;
      color: #777;
      margin-bottom: 10px;
    }
    
    .wallet-amount {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }
    
    .wallet-usd {
      color: #777;
      margin-bottom: 20px;
    }
    
    .withdraw-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
    }
    
    .tasks-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .task-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    
    .task-name {
      font-weight: 500;
    }
    
    .task-coins {
      color: var(--primary);
      font-weight: 600;
      margin-top: 5px;
    }
    
    .earn-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .earn-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      width: 90%;
      max-width: 400px;
      border-radius: 15px;
      overflow: hidden;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      background: var(--primary);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .close-modal {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 16px;
    }
    
    .modal-select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 16px;
      background: white;
    }
    
    .payment-fields {
      display: none;
      margin-bottom: 15px;
    }
    
    .payment-label {
      font-weight: 500;
      margin-bottom: 5px;
      display: block;
    }
    
    .modal-footer {
      padding: 15px 20px;
      background: #f9f9f9;
      text-align: right;
    }
    
    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .modal-btn-primary {
      background: var(--primary);
      color: white;
    }
    
    #adContainer {
      height: 300px;
      background: #2D3436;
      border-radius: 10px;
      margin-bottom: 15px;
      overflow: hidden;
    }
    
    #countdown {
      text-align: center;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .balance-info {
      text-align: center;
      margin-bottom: 15px;
      font-weight: 500;
      color: var(--primary);
    }
    
    /* Invite Modal Styles */
    .referral-code {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      letter-spacing: 2px;
    }
    
    .copy-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 15px;
    }
    
    .share-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    
    .share-btn {
      padding: 10px 15px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    
    /* Notification */
    .notification {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 25px;
      border-radius: 10px;
      color: white;
      font-weight: 500;
      z-index: 1001;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .network-notice {
      font-size: 12px;
      color: var(--error);
      text-align: center;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <!-- Login/Signup Section -->
  <div class="app-container" id="authContainer">
    <div class="logo-container">
      <h1>EarnX</h1>
      <p>Earn rewards with every action</p>
    </div>
    
    <div class="auth-box">
      <!-- Signup Box (Now shown by default) -->
      <div id="signupBox">
        <div id="signupMsg" class="message"></div>
        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" class="modal-input" placeholder="Enter your full name">
        </div>
        <div class="form-group">
          <label for="emailPhone">Email or Phone</label>
          <input type="text" id="emailPhone" class="modal-input" placeholder="Enter your email or phone">
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <div class="input-with-icon">
            <input type="password" id="password" class="modal-input" placeholder="Create a password (min. 6 characters)">
            <button class="password-toggle" onclick="togglePassword('password')">
              <svg class="eye-icon" viewBox="0 0 24 24">
                <path d="M15 12c0 1.654-1.346 3-3 3s-3-1.346-3-3 1.346-3 3-3 3 1.346 3 3zm9-.449s-4.251 8.449-11.985 8.449c-7.18 0-12.015-8.449-12.015-8.449s4.446-7.551 12.015-7.551c7.694 0 11.985 7.551 11.985 7.551zm-7 .449c0-2.757-2.243-5-5-5s-5 2.243-5 5 2.243 5 5 5 5-2.243 5-5z"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirm Password</label>
          <div class="input-with-icon">
            <input type="password" id="confirmPassword" class="modal-input" placeholder="Confirm your password">
            <button class="password-toggle" onclick="togglePassword('confirmPassword')">
              <svg class="eye-icon" viewBox="0 0 24 24">
                <path d="M15 12c0 1.654-1.346 3-3 3s-3-1.346-3-3 1.346-3 3-3 3 1.346 3 3zm9-.449s-4.251 8.449-11.985 8.449c-7.18 0-12.015-8.449-12.015-8.449s4.446-7.551 12.015-7.551c7.694 0 11.985 7.551 11.985 7.551zm-7 .449c0-2.757-2.243-5-5-5s-5 2.243-5 5 2.243 5 5 5 5-2.243 5-5z"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label for="referral">Referral Code (Optional)</label>
          <input type="text" id="referral" class="modal-input" placeholder="Enter referral code if any">
        </div>
        <button id="signupBtn" class="btn btn-primary" onclick="signup()">Sign Up</button>
        <div id="signupLoading" class="loading">
          <div class="loading-spinner"></div>
        </div>
        <div class="auth-links">
          <p>Already have an account? <a href="javascript:void(0)" onclick="showLogin()">Login</a></p>
        </div>
      </div>
      
      <!-- Login Box -->
      <div id="loginBox" style="display:none">
        <div id="loginMsg" class="message"></div>
        <div class="form-group">
          <label for="loginEmailPhone">Email or Phone</label>
          <input type="text" id="loginEmailPhone" class="modal-input" placeholder="Enter your email or phone">
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <div class="input-with-icon">
            <input type="password" id="loginPassword" class="modal-input" placeholder="Enter your password">
            <button class="password-toggle" onclick="togglePassword('loginPassword')">
              <svg class="eye-icon" viewBox="0 0 24 24">
                <path d="M15 12c0 1.654-1.346 3-3 3s-3-1.346-3-3 1.346-3 3-3 3 1.346 3 3zm9-.449s-4.251 8.449-11.985 8.449c-7.18 0-12.015-8.449-12.015-8.449s4.446-7.551 12.015-7.551c7.694 0 11.985 7.551 11.985 7.551zm-7 .449c0-2.757-2.243-5-5-5s-5 2.243-5 5 2.243 5 5 5 5-2.243 5-5z"/>
              </svg>
            </button>
          </div>
        </div>
        <button id="loginBtn" class="btn btn-primary" onclick="login()">Login</button>
        <div id="loginLoading" class="loading">
          <div class="loading-spinner"></div>
        </div>
        <div class="auth-links">
          <p>Don't have an account? <a href="javascript:void(0)" onclick="showSignup()">Sign up</a></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Home Page Section -->
  <div id="homePage">
    <header>
        <div class="welcome" id="welcomeMessage">My Account</div>
        <div class="header-buttons">
          <button class="invite-btn" id="inviteBtn">Invite</button>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </header>
    
    <!-- Updated How to Earn Section -->
    <div class="earn-box">
        <div class="earn-title">How to Earn</div>
        <div class="earn-item">
            <div class="earn-info">
                <span>Watch Browser Ads</span>
                <span class="earn-reward" id="adEarnText">Earn up to 10 coins per ad</span>
            </div>
        </div>
        <div class="earn-item">
            <div class="earn-info">
                <span>Invite Friends</span>
                <span class="earn-reward" id="referralEarnText">Earn 200 coins per referral</span>
            </div>
        </div>
        <div class="conversion-rate" id="conversionText">6000 coins = 1 USD | Minimum withdrawal: 25000 coins (5 USD)</div>
    </div>
    
    <div class="wallet-card">
        <div class="wallet-title">Your Balance</div>
        <div class="wallet-amount" id="userBalance">0 coins</div>
        <div classwallet-usd" id="usdValue">0.00 USD</div>
        <button class="withdraw-btn" id="withdrawBtn">Withdraw</button>
    </div>
    
    <div class="tasks-section">
        <div class="section-title">Available Tasks</div>
        <div id="adsContainer">
            <!-- Ads will be loaded here -->
        </div>
    </div>
  </div>

  <!-- Withdraw Modal -->
  <div class="modal" id="withdrawModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Withdraw Funds</h3>
            <button class="close-modal" id="closeWithdraw">&times;</button>
        </div>
        <div class="modal-body">
            <div class="balance-info">
                Available Balance: <span id="availableBalance">0</span> coins
            </div>
            <div class="form-group">
                <label>Amount (Min. 25,000 coins = $5)</label>
                <input type="number" id="withdrawAmount" class="modal-input" placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label>Payment Method</label>
                <select id="paymentMethod" class="modal-select" onchange="updatePaymentFields()">
                    <option value="easypaisa">Easypaisa</option>
                    <option value="jazzcash">JazzCash</option>
                    <option value="bank">Bank Transfer (Pak)</option>
                    <option value="binance">Binance</option>
                </select>
            </div>
            
            <!-- Easypaisa Fields -->
            <div id="easypaisaFields" class="payment-fields">
                <span class="payment-label">Easypaisa Detail</span>
                <input type="text" class="modal-input" placeholder="Enter Easypaisa Number or ID">
            </div>
            
            <!-- JazzCash Fields -->
            <div id="jazzcashFields" class="payment-fields">
                <span class="payment-label">JazzCash Detail</span>
                <input type="text" class="modal-input" placeholder="Enter Jazzcash Number or TID">
            </div>
            
            <!-- Bank Transfer Fields -->
            <div id="bankFields" class="payment-fields">
                <span class="payment-label">Bank Account Name</span>
                <input type="text" class="modal-input" placeholder="e.g. HBL, UBL, NBP, etc">
                
                <span class="payment-label">User Name</span>
                <input type="text" class="modal-input" placeholder="Bank user name in bank">
                
                <span class="payment-label">Bank Account Number</span>
                <input type="text" class="modal-input" placeholder="Pkxx xxxx xxxx xxxx xxxx">
            </div>
            
            <!-- Binance Fields -->
            <div id="binanceFields" class="payment-fields">
                <span class="payment-label">Select Currency</span>
                <select class="modal-select">
                    <option value="BTC">BTC</option>
                    <option value="ETH">ETH</option>
                    <option value="USDT">USDT</option>
                    <option value="BNB">BNB</option>
                    <option value="SOL">SOL</option>
                    <option value="MATIC">MATIC</option>
                </select>
                
                <span class="payment-label">Network Link</span>
                <input type="text" class="modal-input" placeholder="1A1zP1eP5xxxxxxxxxxxxxxxxxxxxxxxxxx">
                <div class="network-notice">Double check your network link</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-primary" id="submitWithdraw">Submit Request</button>
        </div>
    </div>
  </div>

  <!-- Ad Modal -->
  <div class="modal" id="adModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="adTitle">Watch Ad</h3>
            <button class="close-modal" id="closeAd">&times;</button>
        </div>
        <div class="modal-body">
            <div id="adContainer">
                <!-- Ad content will be loaded here -->
            </div>
            <div id="countdown">Please wait 5 seconds to earn coins</div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-primary" id="completeAdBtn" disabled>Complete & Earn Coins</button>
        </div>
    </div>
  </div>

  <!-- Invite Modal -->
  <div class="modal" id="inviteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Invite Friends</h3>
            <button class="close-modal" id="closeInvite">&times;</button>
        </div>
        <div class="modal-body">
            <p style="text-align: center; margin-bottom: 15px;">Share your referral code with friends and earn 200 coins for each successful referral!</p>
            
            <div class="referral-code" id="userReferralCode">LOADING...</div>
            
            <button class="copy-btn" id="copyReferralBtn">Copy Referral Code</button>
            
            <p style="text-align: center; margin: 15px 0;">Or share directly via:</p>
            
            <div class="share-buttons">
                <button class="share-btn" onclick="shareViaWhatsApp()">WhatsApp</button>
                <button class="share-btn" onclick="shareViaOther()">Other Apps</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <!-- Audio elements for sound effects -->
  <audio id="clickSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" type="audio/mpeg">
  </audio>
  
  <audio id="withdrawSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-cash-machine-payment-received-890.mp3" type="audio/mpeg">
  </audio>
  
  <audio id="logoutSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
  </audio>

  <script>
    // 👇 Apna Google Apps Script Deployment URL yahan paste karo
    // Replace with your actual Google Apps Script URL
    const scriptURL = "https://script.google.com/macros/s/AKfycbzDBTobvZ_R-ToBEV-k8xSn4TuP57-q4BvWpbnKVEAkk3ZCBnNi1S6SBC3ApqguSYDk8g/exec";
    
    let userData = null;
    let adCooldowns = {}; // Track ad cooldowns
    
    // Check if user is already logged in
    document.addEventListener('DOMContentLoaded', function() {
      const savedUser = localStorage.getItem('earnx_user');
      if (savedUser) {
        userData = JSON.parse(savedUser);
        showHomePage(userData);
      }
      
      // Check if there's a referral code in URL parameters
      if (window.refCode) {
        document.getElementById('referral').value = window.refCode;
        document.getElementById('referral').disabled = true;
        showNotification("Referral code applied successfully!");
      }
    });
    
    // Update payment fields based on selection
    function updatePaymentFields() {
      const method = document.getElementById("paymentMethod").value;
      
      // Hide all fields first
      document.getElementById("easypaisaFields").style.display = "none";
      document.getElementById("jazzcashFields").style.display = "none";
      document.getElementById("bankFields").style.display = "none";
      document.getElementById("binanceFields").style.display = "none";
      
      // Show selected fields
      if (method === "easypaisa") {
        document.getElementById("easypaisaFields").style.display = "block";
      } else if (method === "jazzcash") {
        document.getElementById("jazzcashFields").style.display = "block";
      } else if (method === "bank") {
        document.getElementById("bankFields").style.display = "block";
      } else if (method === "binance") {
        document.getElementById("binanceFields").style.display = "block";
      }
    }
    
    // Play click sound
    function playClickSound() {
      const clickSound = document.getElementById("clickSound");
      clickSound.currentTime = 0;
      clickSound.play().catch(e => console.log("Sound play error:", e));
    }
    
    // Play withdraw success sound
    function playWithdrawSound() {
      const withdrawSound = document.getElementById("withdrawSound");
      withdrawSound.currentTime = 0;
      withdrawSound.play().catch(e => console.log("Sound play error:", e));
    }
    
    // Play logout sound
    function playLogoutSound() {
      const logoutSound = document.getElementById("logoutSound");
      logoutSound.currentTime = 0;
      logoutSound.play().catch(e => console.log("Sound play error:", e));
    }
    
    // Toggle password visibility
    function togglePassword(inputId) {
      playClickSound();
      const input = document.getElementById(inputId);
      const toggleBtn = input.parentNode.querySelector('.password-toggle');
      const eyeIcon = toggleBtn.querySelector('.eye-icon');
      
      if (input.type === 'password') {
        input.type = 'text';
        // Change to hide icon
        eyeIcon.innerHTML = '<path d="M11.885 14.988l3.104-3.098.011.11c0 1.654-1.346 3-3 3l-.115-.012zm8.048-8.032l-3.274 3.268c.212.554.341 1.149.341 1.776 0 2.757-2.243 5-5 5-.631 0-1.229-.13-1.785-.344l-2.377 2.372c1.276.588 2.671.972 4.177.972 7.733 0 11.985-8.449 11.985-8.449s-1.415-2.478-4.067-4.595zm1.431-3.536l-18.619 18.58-1.382-1.422 3.455-3.447c-3.022-2.45-4.818-5.58-4.818-5.58s4.446-7.551 12.015-7.551c1.825 0 3.456.426 4.886 1.075l3.081-3.075 1.382 1.42zm-13.751 10.922l1.519-1.515c-.077-.264-.132-.538-.132-.827 0-1.654 1.346-3 3-3 .291 0 .567.055.833.134l1.518-1.515c-.704-.382-1.496-.619-2.351-.619-2.757 0-5 2.243-5 5 0 .852.235 1.641.613 2.342z"/>';
      } else {
        input.type = 'password';
        // Change to show icon
        eyeIcon.innerHTML = '<path d="M15 12c0 1.654-1.346 3-3 3s-3-1.346-3-3 1.346-3 3-3 3 1.346 3 3zm9-.449s-4.251 8.449-11.985 8.449c-7.18 0-12.015-8.449-12.015-8.449s4.446-7.551 12.015-7.551c7.694 0 11.985 7.551 11.985 7.551zm-7 .449c0-2.757-2.243-5-5-5s-5 2.243-5 5 2.243 5 5 5 5-2.243 5-5z"/>';
      }
    }
    
    // Toggle between login and signup
    function showLogin(){
      playClickSound();
      document.getElementById("signupBox").style.display="none";
      document.getElementById("loginBox").style.display="block";
      clearMessages();
    }
    
    function showSignup(){
      playClickSound();
      document.getElementById("loginBox").style.display="none";
      document.getElementById("signupBox").style.display="block";
      clearMessages();
    }
    
    // Clear messages
    function clearMessages() {
      document.getElementById("signupMsg").style.display = 'none';
      document.getElementById("loginMsg").style.display = 'none';
    }
    
    // Show home page
    function showHomePage(user) {
      userData = user;
      document.getElementById("authContainer").style.display = "none";
      document.getElementById("homePage").style.display = "block";
      
      // Set user data with name from sheet
      document.getElementById("welcomeMessage").textContent = `Welcome, ${user.name}`;
      
      // Load wallet balance
      const savedBalance = localStorage.getItem('earnx_balance');
      if (savedBalance) {
        document.getElementById("userBalance").textContent = `${parseFloat(savedBalance).toLocaleString()} coins`;
        const usdValue = (parseFloat(savedBalance) * 0.0002).toFixed(2);
        document.getElementById("usdValue").textContent = `${usdValue} USD`;
      }
      
      // Set up event listeners for home page
      setupHomePageEvents();
    }
    
    // Setup home page event listeners
    function setupHomePageEvents() {
      // Logout button
      document.getElementById("logoutBtn").addEventListener("click", function() {
        playLogoutSound();
        localStorage.removeItem('earnx_user');
        localStorage.removeItem('earnx_balance');
        document.getElementById("homePage").style.display = "none";
        document.getElementById("authContainer").style.display = "block";
        showSignup(); // Show signup page by default after logout
      });
      
      // Invite button
      document.getElementById("inviteBtn").addEventListener("click", function() {
        document.getElementById("userReferralCode").textContent = userData.referralCode || "NOT ASSIGNED";
        document.getElementById("inviteModal").style.display = "flex";
      });
      
      // Close invite modal
      document.getElementById("closeInvite").addEventListener("click", function() {
        document.getElementById("inviteModal").style.display = "none";
      });
      
      // Copy referral code
      document.getElementById("copyReferralBtn").addEventListener("click", function() {
        const referralCode = userData.referralCode;
        if (referralCode && referralCode !== "NOT ASSIGNED") {
          navigator.clipboard.writeText(referralCode).then(() => {
            showNotification("Referral code copied to clipboard!");
          }).catch(err => {
            // Fallback for browsers that don't support clipboard API
            const tempInput = document.createElement("input");
            tempInput.value = referralCode;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            showNotification("Referral code copied to clipboard!");
          });
        }
      });
      
      // Withdraw button
      document.getElementById("withdrawBtn").addEventListener("click", function() {
        // Show available balance in modal
        const savedBalance = localStorage.getItem('earnx_balance') || "0";
        document.getElementById("availableBalance").textContent = parseFloat(savedBalance).toLocaleString();
        document.getElementById("withdrawModal").style.display = "flex";
        
        // Initialize payment fields
        updatePaymentFields();
      });
      
      // Close withdraw modal
      document.getElementById("closeWithdraw").addEventListener("click", function() {
        document.getElementById("withdrawModal").style.display = "none";
      });
      
      // Submit withdrawal
      document.getElementById("submitWithdraw").addEventListener("click", function() {
        const amount = parseInt(document.getElementById("withdrawAmount").value);
        const method = document.getElementById("paymentMethod").value;
        
        if (isNaN(amount) || amount < 25000) {
          showNotification("Minimum withdrawal is 25,000 coins (5 USD)", "error");
          return;
        }
        
        const savedBalance = localStorage.getItem('earnx_balance') || "0";
        if (amount > parseFloat(savedBalance)) {
          showNotification("You don't have enough coins", "error");
          return;
        }
        
        // Simulate withdrawal request
        playWithdrawSound();
        showNotification("Withdrawal request submitted successfully!");
        document.getElementById("withdrawModal").style.display = "none";
      });
      
      // Close ad modal
      document.getElementById("closeAd").addEventListener("click", function() {
        document.getElementById("adModal").style.display = "none";
      });
      
      // Complete ad button
      document.getElementById("completeAdBtn").addEventListener("click", function() {
        // Get current balance
        let currentBalance = parseFloat(localStorage.getItem('earnx_balance') || '0');
        
        // Add reward (10 coins for watching ad)
        currentBalance += 10;
        
        // Save new balance
        localStorage.setItem('earnx_balance', currentBalance.toString());
        
        // Update UI
        document.getElementById("userBalance").textContent = `${currentBalance.toLocaleString()} coins`;
        const usdValue = (currentBalance * 0.0002).toFixed(2);
        document.getElementById("usdValue").textContent = `${usdValue} USD`;
        
        // Show success message
        showNotification("You earned 10 coins for watching the ad!");
        
        // Lock this ad for 30 seconds
        const adId = document.getElementById("adTitle").getAttribute("data-ad-id");
        adCooldowns[adId] = Date.now();
        updateAdButtons();
        
        // Close modal
        document.getElementById("adModal").style.display = "none";
      });
      
      // Load ads from spreadsheet
      loadAds();
    }
    
    // Load ads from spreadsheet
    function loadAds() {
      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({
          action: "getAds"
        })
      })
      .then(res => res.json())
      .then(ads => {
        const adsContainer = document.getElementById("adsContainer");
        adsContainer.innerHTML = "";
        
        if (ads.length === 0) {
          adsContainer.innerHTML = "<p style='text-align:center; color:var(--dark);'>No ads available at the moment</p>";
          return;
        }
        
        ads.forEach((ad, index) => {
          const adCard = document.createElement("div");
          adCard.className = "task-card";
          adCard.innerHTML = `
            <div class="task-info">
              <div class="task-name">${ad.name}</div>
              <div class="task-coins">+10 coins</div>
            </div>
            <button class="earn-btn" data-ad-id="${index}">Earn</button>
          `;
          adsContainer.appendChild(adCard);
          
          // Add click event to earn button
          adCard.querySelector(".earn-btn").addEventListener("click", function() {
            playClickSound();
            startAdTask(ad, index);
          });
        });
        
        // Update button states based on cooldowns
        updateAdButtons();
      })
      .catch(error => {
        console.error('Error loading ads:', error);
        const adsContainer = document.getElementById("adsContainer");
        adsContainer.innerHTML = "<p style='text-align:center; color:var(--error);'>Error loading ads. Please try again later.</p>";
      });
    }
    
    // Update ad buttons based on cooldowns
    function updateAdButtons() {
      const earnButtons = document.querySelectorAll(".earn-btn");
      earnButtons.forEach(button => {
        const adId = button.getAttribute("data-ad-id");
        const lastClicked = adCooldowns[adId];
        
        if (lastClicked) {
          const secondsSinceClick = (Date.now() - lastClicked) / 1000;
          const cooldownSeconds = 30; // 30 seconds cooldown
          
          if (secondsSinceClick < cooldownSeconds) {
            const remaining = Math.ceil(cooldownSeconds - secondsSinceClick);
            button.textContent = `Wait ${remaining}s`;
            button.disabled = true;
            
            // Set timeout to re-enable button
            setTimeout(() => {
              button.textContent = "Earn";
              button.disabled = false;
            }, (cooldownSeconds - secondsSinceClick) * 1000);
          } else {
            button.textContent = "Earn";
            button.disabled = false;
          }
        }
      });
    }
    
    // Start ad task
    function startAdTask(ad, adId) {
      document.getElementById("adTitle").textContent = ad.name;
      document.getElementById("adTitle").setAttribute("data-ad-id", adId);
      document.getElementById("adContainer").innerHTML = `
        <iframe src="${ad.url}" style="width:100%; height:300px; border:none;"></iframe>
      `;
      
      // Start countdown (5 seconds)
      let seconds = 5;
      document.getElementById("countdown").textContent = `Please watch for ${seconds} seconds to earn coins`;
      document.getElementById("completeAdBtn").disabled = true;
      
      const countdown = setInterval(() => {
        seconds--;
        document.getElementById("countdown").textContent = `Please watch for ${seconds} seconds to earn coins`;
        
        if (seconds <= 0) {
          clearInterval(countdown);
          document.getElementById("countdown").textContent = "Ad completed! Click the button to claim your coins";
          document.getElementById("completeAdBtn").disabled = false;
        }
      }, 1000);
      
      document.getElementById("adModal").style.display = "flex";
    }
    
    // Share via WhatsApp
    function shareViaWhatsApp() {
      const referralCode = userData.referralCode;
      const message = `Join EarnX using my referral code: ${referralCode}. Sign up now and earn bonus coins! ${window.location.origin}?ref=${referralCode}`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }
    
    // Share via other apps
    function shareViaOther() {
      const referralCode = userData.referralCode;
      const shareText = `Join EarnX using my referral code: ${referralCode}. Sign up now and earn bonus coins! ${window.location.origin}?ref=${referralCode}`;
      
      if (navigator.share) {
        navigator.share({
          title: 'EarnX Referral',
          text: shareText,
          url: window.location.origin + '?ref=' + referralCode
        }).catch(err => {
          console.log('Error sharing:', err);
        });
      } else {
        // Fallback for browsers that don't support Web Share API
        prompt("Copy this message to share:", shareText);
      }
    }
    
    // Show notification
    function showNotification(message, type = "success") {
      const notification = document.getElementById("notification");
      notification.textContent = message;
      notification.style.background = type === "error" ? "var(--error)" : "var(--success)";
      notification.style.display = "block";
      
      setTimeout(() => {
        notification.style.display = "none";
      }, 3000);
    }
    
    // Signup function
    function signup(){
      playClickSound();
      
      let name = document.getElementById("name").value;
      let emailPhone = document.getElementById("emailPhone").value;
      let password = document.getElementById("password").value;
      let confirmPassword = document.getElementById("confirmPassword").value;
      let referral = document.getElementById("referral").value;
      
      const signupMsg = document.getElementById("signupMsg");
      const signupLoading = document.getElementById("signupLoading");
      const signupBtn = document.getElementById("signupBtn");
      
      // Validate password
      if(password.length < 6){
        signupMsg.innerText = "Password must be at least 6 characters.";
        signupMsg.className = "error";
        signupMsg.style.display = "block";
        return;
      }
      
      // Validate password match
      if(password !== confirmPassword){
        signupMsg.innerText = "Passwords do not match.";
        signupMsg.className = "error";
        signupMsg.style.display = "block";
        return;
      }
      
      // Disable button and show loading
      signupBtn.disabled = true;
      signupLoading.style.display = "block";
      signupMsg.style.display = "none";
      
      // Send data to Google Apps Script
      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({
          action: "signup",
          name: name,
          emailPhone: emailPhone,
          password: password,
          referral: referral
        })
      })
      .then(res => res.text())
      .then(msg => {
        signupLoading.style.display = "none";
        signupBtn.disabled = false;
        signupMsg.innerText = msg;
        
        if (msg === "Signup successful!") {
          signupMsg.className = "success";
          // Auto-hide after 2 seconds
          setTimeout(() => {
            signupMsg.style.display = "none";
            showLogin();
            document.getElementById("loginMsg").innerText = "Signup done! Please login now.";
            document.getElementById("loginMsg").className = "success";
            document.getElementById("loginMsg").style.display = "block";
            // Auto-hide login message after 2 seconds
            setTimeout(() => {
              document.getElementById("loginMsg").style.display = "none";
            }, 2000);
          }, 2000);
        } else {
          signupMsg.className = "error";
        }
        
        signupMsg.style.display = "block";
      })
      .catch(error => {
        signupLoading.style.display = "none";
        signupBtn.disabled = false;
        signupMsg.innerText = "An error occurred. Please try again.";
        signupMsg.className = "error";
        signupMsg.style.display = "block";
        console.error('Error:', error);
      });
    }
    
    // Login function
    function login(){
      playClickSound();
      
      let emailPhone = document.getElementById("loginEmailPhone").value;
      let password = document.getElementById("loginPassword").value;
      
      const loginMsg = document.getElementById("loginMsg");
      const loginLoading = document.getElementById("loginLoading");
      const loginBtn = document.getElementById("loginBtn");
      
      // Disable button and show loading
      loginBtn.disabled = true;
      loginLoading.style.display = "block";
      loginMsg.style.display = "none";
      
      // Send data to Google Apps Script
      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({
          action: "login",
          emailPhone: emailPhone,
          password: password
        })
      })
      .then(res => res.json())
      .then(data => {
        loginLoading.style.display = "none";
        loginBtn.disabled = false;
        
        if (data.status === "success") {
          loginMsg.innerText = "Login successful!";
          loginMsg.className = "success";
          
          // Save user data to localStorage with name and referral code from sheet
          const userData = {
            name: data.name,
            emailPhone: document.getElementById("loginEmailPhone").value,
            referralCode: data.referralCode
          };
          localStorage.setItem('earnx_user', JSON.stringify(userData));
          
          // Immediately redirect to home page without delay
          loginMsg.style.display = "none";
          showHomePage(userData);
        } else {
          loginMsg.innerText = data.message;
          loginMsg.className = "error";
          loginMsg.style.display = "block";
        }
      })
      .catch(error => {
        loginLoading.style.display = "none";
        loginBtn.disabled = false;
        loginMsg.innerText = "An error occurred. Please try again.";
        loginMsg.className = "error";
        loginMsg.style.display = "block";
        console.error('Error:', error);
      });
    }
  </script>
</body>
</html>